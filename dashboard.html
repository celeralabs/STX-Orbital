<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STX Orbital – Screening Portal</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Quick inline styles for risk badge colors - add these to style.css permanently */
        .result-status.green { background: #0f3; color: #000; }
        .result-status.yellow { background: #ff0; color: #000; }
        .result-status.red { background: #f00; color: #fff; }
        .download-btn { display: inline-block; margin-top: 20px; padding: 12px 24px; background: #00ffaa; color: #000; text-decoration: none; border-radius: 6px; font-weight: bold; }
        .download-btn:hover { background: #00cc88; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="brand-icon">◆</span>
                <span class="brand-text">STX ORBITAL</span>
            </div>
            <button class="nav-toggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="container">
            <div class="dashboard-header">
                <h1>Fleet Screening Portal</h1>
                <p>Upload TLE file for autonomous conjunction assessment. Analysis completes in 4-8 seconds.</p>
            </div>

            <div id="dropzone" class="dropzone">
                <div class="dropzone-icon">⬢</div>
                <div class="dropzone-text">Drop TLE file here</div>
                <div class="dropzone-subtext">or click to browse (.txt or .tle)</div>
                <input type="file" id="fileInput" accept=".tle,.txt">
            </div>

            <div id="loading" style="display: none; text-align: center; margin: 40px;">
                <p>Processing conjunction screening...</p>
            </div>

            <div id="resultContainer" style="display: none;">
                <div class="result-box">
                    <div id="statusBadge" class="result-status green">RISK LEVEL: GREEN</div>
                    <h2 id="resultTitle" class="result-title"></h2>
                    <div id="resultContent" class="result-content"></div>
                    <div id="recommendationBox" class="recommendation-box" style="display: none;">
                        <h3>Flight Dynamics Officer Assessment</h3>
                        <div id="recommendationText"></div>
                    </div>
                    <a id="downloadLink" class="download-btn" style="display: none;">Download PDF Report</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const statusBadge = document.getElementById('statusBadge');
        const resultTitle = document.getElementById('resultTitle');
        const resultContent = document.getElementById('resultContent');
        const recommendationBox = document.getElementById('recommendationBox');
        const recommendationText = document.getElementById('recommendationText');
        const downloadLink = document.getElementById('downloadLink');

        // Drag & drop + click to select
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.background = 'rgba(0, 255, 170, 0.1)';
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.style.background = '';
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.background = '';
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            location.href = 'login.html';
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.txt') && !file.name.toLowerCase().endsWith('.tle')) {
                alert('Please upload a .txt or .tle file');
                return;
            }

            const formData = new FormData();
            formData.append('tle_file', file);        // backend accepts any key, but we use 'tle_file'
            formData.append('suppress_green', 'false');

            loading.style.display = 'block';
            resultContainer.style.display = 'none';

            fetch('/screen', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer stx-authorized-user'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                if (data.status === 'suppressed') {
                    alert('Event suppressed (GREEN risk level)');
                    return;
                }

                // Success - show results
                resultContainer.style.display = 'block';

                const risk = data.risk_level || 'GREEN';
                statusBadge.textContent = `RISK LEVEL: ${risk}`;
                statusBadge.className = `result-status ${risk.toLowerCase()}`;

                const t = data.threats[0];
                resultTitle.textContent = `${t.asset} vs ${t.intruder}`;

                resultContent.innerHTML = `
                    <strong>TCA (UTC):</strong> ${t.tca}<br>
                    <strong>Miss Distance:</strong> ${t.min_km} km<br>
                    <strong>Relative Velocity:</strong> ${t.relative_velocity_kms} km/s<br>
                    <strong>Collision Probability:</strong> ${t.pc}<br><br>
                    <strong>RIC Geometry (km):</strong><br>
                     • Radial: ${data.geometry.radial:.3f}<br>
                     • In-Track: ${data.geometry.in_track:.3f}<br>
                     • Cross-Track: ${data.geometry.cross_track:.3f}<br><br>
                    <strong>Operational Profile:</strong> ${data.profile}
                `;

                if (data.decision) {
                    recommendationBox.style.display = 'block';
                    recommendationText.innerHTML = data.decision.replace(/\n/g, '<br>');
                } else {
                    recommendationBox.style.display = 'none';
                }

                // PDF download link
                if (data.pdf_url) {
                    downloadLink.href = '/' + data.pdf_url;
                    downloadLink.style.display = 'inline-block';
                    // Optional: auto-trigger download
                    downloadLink.click();
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                console.error(err);
                alert('Upload failed - check console');
            });
        }
    </script>
</body>
</html>